---
name: review
description: コードレビューアシスタント。コードの変更をレビューします。「レビューして」「コードを確認して」「チェックして」「reviewして」などのリクエストで発動します。
allowed-tools: Read, Grep, Glob, Bash(git:*, gh:*)
---

# コードレビューアシスタント

## 手順

1. **対象取得**: `git diff`/`git diff --cached`、空なら `git diff <branch>...HEAD` or `git show HEAD` or `gh pr diff`
2. **コンテキスト理解**: 変更ファイルの全体、呼び出し元/先、テスト、型定義を読む（diffだけで判断しない）
3. **全観点でレビュー**
4. **結果を構造化して出力**

## レビュー観点

### 🔒 セキュリティ（最優先）
- インジェクション: SQL（パラメータ化クエリ使用か）、XSS（エスケープ）、コマンド、パストラバーサル
- 秘密情報: ハードコードされたキー/トークン、ログへの出力、エラーメッセージへの内部情報
- 認証認可: 権限チェック、セッション管理、CSRF対策
- 入力検証: 全外部入力のバリデーション・サニタイズ

### 🐛 正確性・ロジック
- 境界条件: 空配列、null/undefined、0、負数、最大最小値
- オフバイワン: ループ条件、配列インデックス
- null安全: 参照前チェック、オプショナルチェーン（?.）、nullish coalescing（??）
- エラーハンドリング: 例外キャッチ、エラー握りつぶし、伝播
- 非同期: await忘れ、Promise未処理、競合状態、デッドロック
- 状態管理: 不整合、更新漏れ、副作用

### ⚡ パフォーマンス
- 計算量: O(n²)以上のアルゴリズム
- DB: N+1クエリ、不要クエリ、インデックス活用、大量データ一括取得
- メモリ: リーク（リスナー、タイマー、クロージャ）、大オブジェクトコピー
- 不要処理: 重複計算、不要再レンダリング、ループ内の重い処理
- キャッシュ・遅延読み込みの機会、リソース解放

### 🏗️ 設計・アーキテクチャ
- SOLID: 単一責任、オープンクローズド、リスコフ置換、インターフェース分離、依存性逆転
- 依存関係: 循環依存、不適切な依存方向、DI
- 抽象化: 過剰/不足
- 責務分離: UI/ロジック、データアクセス
- 既存パターンとの整合性

### 🔄 リファクタリング機会
- コードの臭い: 長すぎるメソッド/クラス/パラメータリスト、重複コード、switch乱用
- パターン適用: Factory、Builder、State/Strategy、Observer
- 簡略化: 早期リターン、ガード句、配列メソッド活用

### 📖 可読性・保守性
- 命名: 意図を表す名前、一貫した規則、ブール変数はis/has/can/should
- 関数: 長さ（30行目安）、引数数（3-4個目安）、副作用の明確さ
- 条件分岐: ネスト深度（3段階目安）、複雑な条件式、否定条件の乱用
- コメント: 「なぜ」の説明、古いコメント、TODO
- DRY、マジックナンバー/文字列

### 🧪 テスト
- カバレッジ: 新コードのテスト有無
- ケース: 正常系、異常系、境界値、エッジケース
- 質: 振る舞いテスト、独立性、決定性
- モック: 適切な使用、過度なモック

### 🔄 互換性
- 破壊的変更: API/インターフェース、シグネチャ、設定形式
- 後方互換性、非推奨化処理
- マイグレーション: DBスキーマ、設定、データ変換

### 🌐 その他
- ログ: レベル適切か、機密情報含まないか
- 設定: ハードコード、環境分離
- i18n、a11y（フロントエンド）
- リソース管理: ファイルハンドル、DB接続の解放

## 出力形式

```markdown
## レビュー概要
<全体評価2-3文>

## 重大な問題 🚨
- **[ファイル:行]** 問題の説明
  - なぜ問題か
  - 修正案

## 警告 ⚠️
- **[ファイル:行]** 説明と理由

## リファクタリング提案 🔧
- **[ファイル:行]** 改善案

## 提案 💡
## 質問 ❓
## 良い点 ✅
```

## ルール

- **diffだけでなく周辺コードも必ず読む**
- 全観点をチェック
- 具体的に（ファイル名:行番号）
- 問題には修正案を提示
- 重大な問題優先、些細な指摘は後回し
- ユーザーの言語で応答
