---
name: understand
description: プロジェクト理解アシスタント。新規プロジェクトの全体像を俯瞰し、構造・アーキテクチャ・データモデルを分析して理解を助けます。「プロジェクトを理解して」「コードベースを説明して」「全体像を教えて」「アーキテクチャを分析して」「〜について深掘りして」などのリクエストで発動します。
allowed-tools: Read, Grep, Glob, Bash(ls:*, find:*, wc:*, head:*, tree:*, cat:*)
---

# プロジェクト理解アシスタント

**言語・フレームワーク問わず、ユーザーがプロジェクトを完全に理解するまで継続的にサポートする。**

---

## 実行モード判定

### 最初に必ず確認

```bash
ls docs-memo/ 2>/dev/null
```

| 結果 | モード | 説明 |
|-----|--------|------|
| ディレクトリなし/空 | **初回モード** | フル分析を実行 |
| ファイルあり | **継続モード** | 既存ドキュメントを読み込み、続きから |

---

## 🆕 初回モード

### Step 1: セットアップ

```bash
mkdir -p docs-memo
```

`.gitignore`に`docs-memo/`がなければ追加を提案。

### Step 2: 技術スタック検出

| 検出項目 | 確認方法 |
|---------|---------|
| 言語 | 拡張子分布 |
| パッケージ管理 | package.json, go.mod, Cargo.toml, requirements.txt, pyproject.toml, build.gradle, pom.xml, Gemfile, composer.json等 |
| フレームワーク | 設定ファイル、依存関係から推測 |
| DB/ORM | スキーマファイル、マイグレーションから検出 |
| インフラ | Dockerfile, docker-compose.yml, k8s/, terraform/等 |

### Step 3: フル分析実行

以下の9ドキュメントを生成:

1. `index.md` - 目次、クイックスタート、読み順
2. `overview.md` - 技術スタック、ディレクトリ構成
3. `architecture.md` - アーキテクチャパターン、レイヤー図
4. `data-models.md` - エンティティ、ER図
5. `api.md` - エンドポイント、認証フロー
6. `key-files.md` - 重要ファイル、読み順ガイド
7. `glossary.md` - 用語集
8. `how-to-dev.md` - 開発ガイド
9. `flows.md` - 処理フロー図

### Step 4: 進捗ファイル作成

`docs-memo/_progress.md` を作成:

```markdown
# 理解進捗

## 理解度サマリー
| エリア | 状態 | メモ |
|-------|------|------|
| 全体構成 | ✅ 理解 | |
| アーキテクチャ | ✅ 理解 | |
| データモデル | 🔶 概要のみ | 詳細なリレーションは要調査 |
| API | 🔶 概要のみ | 認証フローの詳細が不明 |
| ビジネスロジック | ❌ 未調査 | |
| テスト | ❌ 未調査 | |

## 疑問点・未解決
- [ ] {疑問1}
- [ ] {疑問2}

## 次に調査すべきエリア
1. {推奨調査エリア1}
2. {推奨調査エリア2}

## 調査履歴
| 日付 | 調査内容 | 結果 |
|-----|---------|------|
| {日付} | 初回フル分析 | 完了 |
```

---

## 🔄 継続モード

### Step 1: 現状把握

1. `docs-memo/_progress.md` を読む
2. 既存ドキュメントの内容を把握
3. ユーザーの要望を確認

### Step 2: 要望に応じた対応

| ユーザーの要望 | 対応 |
|--------------|------|
| 「続きをやって」「次は？」 | `_progress.md`の「次に調査すべきエリア」を実行 |
| 「〜について詳しく」 | 該当エリアを深掘り分析、ドキュメント更新 |
| 「〜の処理フローを追って」 | コードを追跡、`flows.md`に追記 |
| 「〜と〜の関係は？」 | 関係を分析、該当ドキュメントに追記 |
| 「〜がわからない」 | 説明＋ドキュメント更新＋疑問解決をマーク |
| 「理解度を確認して」 | `_progress.md`を更新、次のステップを提案 |
| 「全体を見直して」 | 既存ドキュメントをレビュー、更新 |

### Step 3: ドキュメント更新

分析結果を該当ドキュメントに追記・更新:
- 新しい発見 → 該当セクションに追記
- 疑問解決 → `_progress.md`の疑問をチェック
- 理解が深まった → 理解度ステータスを更新

### Step 4: 進捗更新

`_progress.md` を必ず更新:
- 理解度サマリーの更新
- 解決した疑問のチェック
- 新しい疑問の追加
- 調査履歴への追記
- 次に調査すべきエリアの更新

---

## ドキュメント形式

### 共通ヘッダー

各ドキュメントの先頭:

```markdown
# {タイトル}

> 最終更新: {日付}
> ステータス: 概要のみ / 詳細まで理解 / 要更新

---
```

### index.md

```markdown
# {プロジェクト名} - 理解ガイド

> 最終更新: {日付}

## クイックスタート
- **言語**: {検出}
- **フレームワーク**: {検出}
- **起動**: `{検出}`
- **テスト**: `{検出}`

## ドキュメント
| ドキュメント | 内容 | 理解度 |
|-------------|------|--------|
| [overview](./overview.md) | 全体概要 | ✅ |
| [architecture](./architecture.md) | アーキテクチャ | 🔶 |
| [data-models](./data-models.md) | データモデル | ❌ |
| ... | | |

## 読み順
1. {エントリーポイント} - {理由}
2. ...

## 現在の理解度
→ [_progress.md](./_progress.md) を参照
```

### overview.md

```markdown
# プロジェクト概要

> 最終更新: {日付}

## 基本情報
| 項目 | 値 |
|-----|-----|
| プロジェクト名 | |
| 種別 | |
| 言語 | |
| フレームワーク | |

## 技術スタック
| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|

## ディレクトリ構成
{各ディレクトリの役割を注釈付きで}

## エントリーポイント
| ファイル | 役割 |
|---------|------|

## コマンド
| コマンド | 説明 |
|---------|------|
```

### architecture.md

```markdown
# アーキテクチャ

> 最終更新: {日付}

## パターン
**{Clean Architecture / Layered / MVC / etc.}**

## 構成図
\`\`\`mermaid
{検出した構造に基づいて作成}
\`\`\`

## レイヤー/モジュール
| 名前 | ディレクトリ | 責務 |
|-----|-------------|------|

## 依存関係ルール
{import文分析に基づいて}

## 外部連携
| 連携先 | 方式 | 用途 |
|-------|------|------|
```

### data-models.md

```markdown
# データモデル

> 最終更新: {日付}

## スキーマ定義の場所
{パス}

## エンティティ一覧
| エンティティ | テーブル | 説明 |
|-------------|---------|------|

## ER図
\`\`\`mermaid
erDiagram
{検出したモデルに基づいて}
\`\`\`

## 詳細
{各エンティティのフィールド、関連}
```

### api.md

```markdown
# API/インターフェース

> 最終更新: {日付}

## 種別
{REST / GraphQL / gRPC / CLI / Library}

## エンドポイント一覧
{種別に応じた形式}

## 認証・認可
{検出した方式}

## フロー図
\`\`\`mermaid
sequenceDiagram
{代表的なフロー}
\`\`\`
```

### key-files.md

```markdown
# 重要ファイル

> 最終更新: {日付}

## 🔴 最重要
| ファイル | 理由 |
|---------|------|

## 🟠 重要
| ファイル | 理由 |
|---------|------|

## 設定ファイル
| ファイル | 内容 |
|---------|------|

## 読み順
1. {ファイル} - {理由}
```

### glossary.md

```markdown
# 用語集

> 最終更新: {日付}

## ドメイン用語
| 用語 | 意味 | 使用箇所 |
|------|------|---------|

## 技術用語
| 用語 | 意味 |
|------|------|

## 略語
| 略語 | 正式名称 |
|------|---------|
```

### how-to-dev.md

```markdown
# 開発ガイド

> 最終更新: {日付}

## 環境構築
{検出した手順}

## 新機能追加の手順
{既存パターンから推測}

## 参考実装
| パターン | ファイル |
|---------|---------|

## テスト
{構成、実行方法}

## コーディング規約
{既存コードから抽出}
```

### flows.md

```markdown
# 処理フロー

> 最終更新: {日付}

## {フロー名1}
\`\`\`mermaid
sequenceDiagram
{フロー}
\`\`\`

## {フロー名2}
...
```

---

## 深掘り分析

ユーザーが特定エリアの深掘りを要望した場合:

### 対応パターン

| 要望 | 分析内容 | 更新先 |
|-----|---------|--------|
| 「認証の仕組みを詳しく」 | 認証関連コードを追跡、フロー図作成 | api.md, flows.md |
| 「Userエンティティを詳しく」 | フィールド、バリデーション、関連を分析 | data-models.md |
| 「注文処理のフローを追って」 | コードパスを追跡、シーケンス図作成 | flows.md |
| 「このファイルの役割は？」 | ファイルを分析、関連を調査 | 該当ドキュメント |
| 「〜と〜の違いは？」 | 比較分析 | 該当ドキュメント |

### 深掘り結果の記録

1. 該当ドキュメントに詳細セクションを追加
2. 新しい図があれば追加
3. 関連する他ドキュメントも更新
4. `_progress.md` の理解度を更新

---

## 理解度の確認

ユーザーが「理解度を確認して」と言った場合:

1. `_progress.md` を読み込み
2. 各エリアの理解度を評価
3. 未調査・疑問点を整理
4. 次のステップを提案

```markdown
## 現在の理解度

### ✅ 理解できている
- 全体構成
- 技術スタック
- 主要なデータモデル

### 🔶 概要は理解、詳細は未調査
- API認証フロー
- エラーハンドリング

### ❌ 未調査
- テスト戦略
- CI/CD
- 特定のビジネスロジック（注文処理等）

### 推奨される次のステップ
1. 「認証フローを詳しく教えて」
2. 「注文処理の流れを追って」
3. 「テスト構成を分析して」
```

---

## ルール

- **モード判定を最初に**: docs-memo/の有無で初回/継続を判定
- **_progress.mdを常に更新**: 進捗管理の要
- **検出結果に基づいて分析**: 言語/FW固有の慣習を考慮
- **読み取り専用**: コードは変更しない（docs-memoへの書き込みのみ）
- **Mermaid図を活用**: 視覚的理解のため
- **具体的なファイルパスを記載**: 抽象的な説明だけでなく
- **疑問点も正直に記録**: わからないことはわからないと書く
- **次のステップを常に提案**: ユーザーが迷わないように
- ユーザーの言語で応答・記録
